
#+PROPERTY: header-args:jupyter-python+ :dir (file-name-directory buffer-file-name) :session GL_mass_anomaly

* Table of contents                               :toc_3:noexport:
- [[#introduction][Introduction]]
  - [[#data-example][Data example]]
    - [[#printout][Printout]]
    - [[#plot-annual-mass-change-per-region-5-year-smooth][Plot: Annual mass change per region (5 year smooth)]]
    - [[#table-annual-mass-change-per-region][Table: Annual mass change per region]]
- [[#fetch-data][Fetch data]]
- [[#reprocess][Reprocess]]

* Introduction

We provide estimate of the freshwater imbalance with respect to the 1850â€“1900 pre-industrial period. This is defined from the modelled SMB minus the discharge which, by construction, will average to zero over the baseline period for each region and for the ice sheet as a whole.

** Data example

*** Printout

#+BEGIN_SRC jupyter-python :exports results :prologue "import xarray as xr" :display text/plain
xr.open_dataset('./dat/GL_mass_anomaly.nc')
#+END_SRC

#+RESULTS:
#+begin_example
<xarray.Dataset> Size: 27kB
Dimensions:      (region: 7, time: 175)
Coordinates:
  ,* time         (time) datetime64[ns] 1kB 1850-01-01 1851-01-01 ... 2024-01-01
  ,* region       (region) int64 56B 1 2 3 4 5 6 7
Data variables:
    SMB_ROI      (region, time) float32 5kB ...
    SMB_ROI_err  (region, time) float32 5kB ...
    D_ROI        (region, time) float32 5kB ...
    D_ROI_err    (region, time) float32 5kB ...
    region_name  (region) <U2 56B ...
    MB_ROI       (region, time) float32 5kB ...
    MB           (time) float32 700B ...
Attributes: (12/14)
    featureType:      timeSeries
    title:            Greenland ice sheet mass balance by Mouginot region
    summary:          Greenland ice sheet mass balance by Mouginot region
    keywords:         Greenland; Mass; Mass balance
    source:           git commit: 54a4452
    creator_name:     Ken Mankoff
    ...               ...
    institution:      NASA GISS
    references:       TBD
    product_version:  1.0
    history:          TBD
    Conventions:      CF-1.8
    DOI:              https://doi.org/10.5281/zenodo.14020895
#+end_example

*** Plot: Annual mass change per region (5 year smooth)

#+NAME: plotme
#+BEGIN_SRC jupyter-python :exports both :file ./fig/GL_mass_anom.png
import xarray as xr
ds = xr.open_dataset('dat/GL_mass_anomaly.nc')

df = ds['MB_ROI'].to_dataframe()['MB_ROI']

df = df.unstack().T
df.columns = ds['region_name'].values
df['GL'] = df.sum(axis='columns')

ax = df.drop(columns='GL').rolling(window=5, center=True).mean().plot(drawstyle='steps-post')
df['GL'].rolling(window=5, center=True).mean().plot(drawstyle='steps-post', ax=ax, linewidth=2, color='k')

# df_MB = ds['MB_orig'].to_dataframe()['MB_orig']
# df_MB.rolling(window=5, center=True).mean().plot(drawstyle='steps-post', ax=ax, linewidth=3, alpha=0.5)

_ = ax.set_ylabel('Mass balance [Gt yr$^{-1}$]')
#+END_SRC

#+RESULTS: plotme
[[file:./fig/GL_mass_anom.png]]

#+RESULTS:

*** Table: Annual mass change per region

#+begin_src jupyter-python :exports both
import xarray as xr
ds = xr.open_dataset('dat/GL_mass_change.nc')
ds = ds.sel({'time': slice('1800-01-01','2023-12-31')})
df = ds['mass_balance'].to_dataframe()['mass_balance']
df = df.unstack().T
df.columns = [str(_[0]) + ' ['+_[1]+']' for _ in zip(ds['region'].values, ds['region_name'].values)]
df['GL'] = df.sum(axis='columns')
df.index = [str(_)[0:4] for _ in df.index]
df.round()
#+end_src

#+RESULTS:
|      |   1 [CE] |   2 [CW] |   3 [NE] |   4 [NO] |   5 [NW] |   6 [SE] |   7 [SW] |   GL |
|------+----------+----------+----------+----------+----------+----------+----------+------|
| 1840 |      -19 |       33 |       12 |       36 |       55 |       11 |      -18 |  110 |
| 1841 |      -21 |       37 |       14 |       40 |       61 |       12 |      -20 |  122 |
| 1842 |       16 |      -28 |      -10 |      -30 |      -46 |       -9 |       15 |  -92 |
| 1843 |       18 |      -32 |      -12 |      -35 |      -53 |      -11 |       18 | -105 |
| 1844 |       28 |      -48 |      -18 |      -53 |      -80 |      -16 |       27 | -161 |
| 1845 |       17 |      -29 |      -11 |      -32 |      -48 |      -10 |       16 |  -96 |
| 1846 |      -16 |       28 |       10 |       31 |       47 |        9 |      -16 |   93 |
| 1847 |      -33 |       56 |       21 |       62 |       94 |       19 |      -31 |  187 |
| 1848 |       25 |      -42 |      -16 |      -47 |      -71 |      -14 |       24 | -141 |
| 1849 |      -11 |       19 |        7 |       21 |       31 |        6 |      -11 |   63 |
| 1850 |        8 |      -13 |       -5 |      -15 |      -22 |       -5 |        7 |  -45 |
| 1851 |       -8 |       13 |        5 |       14 |       22 |        4 |       -7 |   44 |
| 1852 |       11 |      -19 |       -7 |      -21 |      -31 |       -6 |       11 |  -63 |
| 1853 |       13 |      -23 |       -9 |      -25 |      -38 |       -8 |       13 |  -77 |
| 1854 |        0 |       -0 |       -0 |       -0 |       -0 |       -0 |        0 |   -0 |
| 1855 |      -14 |       24 |        9 |       26 |       40 |        8 |      -13 |   80 |
| 1856 |      -20 |       34 |       13 |       37 |       57 |       12 |      -19 |  114 |
| 1857 |       27 |      -47 |      -17 |      -51 |      -78 |      -16 |       26 | -156 |
| 1858 |       27 |      -47 |      -17 |      -51 |      -78 |      -16 |       26 | -155 |
| 1859 |        4 |       -6 |       -2 |       -7 |      -10 |       -2 |        3 |  -21 |
| 1860 |        3 |       -6 |       -2 |       -6 |      -10 |       -2 |        3 |  -19 |
| 1861 |      -11 |       20 |        7 |       21 |       32 |        7 |      -11 |   65 |
| 1862 |      -13 |       22 |        8 |       24 |       36 |        7 |      -12 |   73 |
| 1863 |      -26 |       44 |       16 |       49 |       74 |       15 |      -25 |  148 |
| 1864 |      -18 |       32 |       12 |       35 |       52 |       11 |      -18 |  105 |
| 1865 |       -2 |        3 |        1 |        3 |        5 |        1 |       -2 |    9 |
| 1866 |        6 |      -10 |       -4 |      -11 |      -17 |       -3 |        6 |  -34 |
| 1867 |       10 |      -17 |       -6 |      -19 |      -28 |       -6 |       10 |  -57 |
| 1868 |      -27 |       46 |       17 |       51 |       77 |       16 |      -26 |  155 |
| 1869 |       -8 |       14 |        5 |       15 |       23 |        5 |       -8 |   45 |
| 1870 |        0 |       -0 |       -0 |       -0 |       -0 |       -0 |        0 |   -0 |
| 1871 |        9 |      -16 |       -6 |      -17 |      -26 |       -5 |        9 |  -52 |
| 1872 |        5 |       -9 |       -3 |      -10 |      -15 |       -3 |        5 |  -30 |
| 1873 |      -14 |       24 |        9 |       26 |       40 |        8 |      -13 |   80 |
| 1874 |        8 |      -15 |       -5 |      -16 |      -24 |       -5 |        8 |  -48 |
| 1875 |      -11 |       18 |        7 |       20 |       30 |        6 |      -10 |   61 |
| 1876 |       -5 |        9 |        3 |       10 |       15 |        3 |       -5 |   30 |
| 1877 |       42 |      -73 |      -27 |      -79 |     -121 |      -24 |       40 | -241 |
| 1878 |      -12 |       21 |        8 |       23 |       35 |        7 |      -12 |   70 |
| 1879 |       -2 |        4 |        2 |        4 |        7 |        1 |       -2 |   14 |
| 1880 |       -5 |        8 |        3 |        9 |       13 |        3 |       -4 |   26 |
| 1881 |        4 |       -7 |       -2 |       -7 |      -11 |       -2 |        4 |  -22 |
| 1882 |       10 |      -17 |       -6 |      -19 |      -29 |       -6 |       10 |  -57 |
| 1883 |        6 |      -10 |       -4 |      -11 |      -17 |       -3 |        6 |  -34 |
| 1884 |       -5 |        9 |        3 |       10 |       15 |        3 |       -5 |   29 |
| 1885 |        5 |       -9 |       -3 |      -10 |      -16 |       -3 |        5 |  -31 |
| 1886 |        5 |       -9 |       -3 |       -9 |      -14 |       -3 |        5 |  -28 |
| 1887 |        5 |       -9 |       -3 |       -9 |      -14 |       -3 |        5 |  -29 |
| 1888 |        7 |      -13 |       -5 |      -14 |      -21 |       -4 |        7 |  -42 |
| 1889 |      -34 |       59 |       22 |       65 |       98 |       20 |      -33 |  197 |
| 1890 |        5 |       -8 |       -3 |       -9 |      -14 |       -3 |        5 |  -27 |
| 1891 |        7 |      -11 |       -4 |      -12 |      -19 |       -4 |        6 |  -37 |
| 1892 |       21 |      -36 |      -13 |      -39 |      -59 |      -12 |       20 | -119 |
| 1893 |        5 |       -9 |       -3 |       -9 |      -14 |       -3 |        5 |  -29 |
| 1894 |        6 |      -10 |       -4 |      -11 |      -17 |       -3 |        6 |  -33 |
| 1895 |      -19 |       32 |       12 |       36 |       54 |       11 |      -18 |  108 |
| 1896 |       -8 |       13 |        5 |       14 |       22 |        4 |       -7 |   43 |
| 1897 |        6 |       -9 |       -4 |      -10 |      -16 |       -3 |        5 |  -31 |
| 1898 |      -36 |       61 |       23 |       67 |      102 |       21 |      -34 |  203 |
| 1899 |        8 |      -14 |       -5 |      -15 |      -23 |       -5 |        8 |  -46 |
| 1900 |       38 |      -65 |      -24 |      -71 |     -108 |      -22 |       36 | -216 |
| 1901 |      -29 |       50 |       19 |       55 |       83 |       17 |      -28 |  166 |
| 1902 |       12 |      -21 |       -8 |      -23 |      -35 |       -7 |       12 |  -69 |
| 1903 |       26 |      -45 |      -17 |      -49 |      -74 |      -15 |       25 | -148 |
| 1904 |       52 |      -90 |      -33 |      -98 |     -149 |      -30 |       50 | -299 |
| 1905 |        9 |      -15 |       -6 |      -17 |      -26 |       -5 |        9 |  -51 |
| 1906 |       31 |      -54 |      -20 |      -59 |      -89 |      -18 |       30 | -179 |
| 1907 |       26 |      -45 |      -17 |      -49 |      -75 |      -15 |       25 | -149 |
| 1908 |       28 |      -49 |      -18 |      -54 |      -81 |      -17 |       27 | -163 |
| 1909 |       20 |      -35 |      -13 |      -38 |      -58 |      -12 |       20 | -116 |
| 1910 |       16 |      -27 |      -10 |      -30 |      -45 |       -9 |       15 |  -90 |
| 1911 |      -11 |       20 |        7 |       21 |       33 |        7 |      -11 |   65 |
| 1912 |       26 |      -45 |      -17 |      -49 |      -74 |      -15 |       25 | -148 |
| 1913 |       15 |      -27 |      -10 |      -29 |      -44 |       -9 |       15 |  -88 |
| 1914 |        1 |       -1 |       -0 |       -1 |       -2 |       -0 |        1 |   -4 |
| 1915 |        6 |      -11 |       -4 |      -12 |      -19 |       -4 |        6 |  -37 |
| 1916 |      -23 |       39 |       15 |       43 |       65 |       13 |      -22 |  131 |
| 1917 |       25 |      -43 |      -16 |      -47 |      -71 |      -14 |       24 | -141 |
| 1918 |       -0 |        0 |        0 |        0 |        1 |        0 |       -0 |    1 |
| 1919 |        1 |       -1 |       -0 |       -1 |       -2 |       -0 |        1 |   -4 |
| 1920 |        9 |      -15 |       -6 |      -17 |      -25 |       -5 |        8 |  -50 |
| 1921 |       13 |      -22 |       -8 |      -24 |      -37 |       -7 |       12 |  -74 |
| 1922 |      -18 |       32 |       12 |       35 |       53 |       11 |      -18 |  105 |
| 1923 |       22 |      -37 |      -14 |      -41 |      -62 |      -13 |       21 | -124 |
| 1924 |       42 |      -73 |      -27 |      -80 |     -121 |      -25 |       41 | -242 |
| 1925 |       -8 |       14 |        5 |       16 |       24 |        5 |       -8 |   48 |
| 1926 |       57 |      -99 |      -37 |     -108 |     -164 |      -33 |       55 | -328 |
| 1927 |       13 |      -22 |       -8 |      -25 |      -37 |       -8 |       13 |  -75 |
| 1928 |       49 |      -85 |      -32 |      -93 |     -141 |      -29 |       47 | -282 |
| 1929 |       31 |      -54 |      -20 |      -59 |      -90 |      -18 |       30 | -179 |
| 1930 |       22 |      -38 |      -14 |      -41 |      -63 |      -13 |       21 | -125 |
| 1931 |       90 |     -154 |      -57 |     -169 |     -257 |      -52 |       86 | -513 |
| 1932 |       17 |      -29 |      -11 |      -32 |      -49 |      -10 |       16 |  -97 |
| 1933 |       31 |      -54 |      -20 |      -59 |      -89 |      -18 |       30 | -179 |
| 1934 |       28 |      -49 |      -18 |      -53 |      -81 |      -16 |       27 | -162 |
| 1935 |       63 |     -109 |      -40 |     -119 |     -181 |      -37 |       61 | -361 |
| 1936 |       40 |      -70 |      -26 |      -76 |     -116 |      -23 |       39 | -231 |
| 1937 |       31 |      -54 |      -20 |      -59 |      -89 |      -18 |       30 | -179 |
| 1938 |       16 |      -28 |      -10 |      -30 |      -46 |       -9 |       15 |  -92 |
| 1939 |        5 |       -9 |       -3 |      -10 |      -15 |       -3 |        5 |  -30 |
| 1940 |        5 |       -8 |       -3 |       -9 |      -14 |       -3 |        5 |  -27 |
| 1941 |       13 |      -23 |       -8 |      -25 |      -38 |       -8 |       13 |  -75 |
| 1942 |        5 |       -8 |       -3 |       -9 |      -13 |       -3 |        5 |  -27 |
| 1943 |       33 |      -56 |      -21 |      -61 |      -93 |      -19 |       31 | -186 |
| 1944 |        9 |      -15 |       -6 |      -16 |      -25 |       -5 |        8 |  -50 |
| 1945 |      -25 |       44 |       16 |       48 |       72 |       15 |      -24 |  145 |
| 1946 |      -16 |       27 |       10 |       29 |       44 |        9 |      -15 |   89 |
| 1947 |       -5 |        8 |        3 |        9 |       13 |        3 |       -5 |   27 |
| 1948 |       41 |      -71 |      -26 |      -77 |     -117 |      -24 |       39 | -235 |
| 1949 |       57 |      -98 |      -36 |     -107 |     -163 |      -33 |       55 | -325 |
| 1950 |       48 |      -82 |      -30 |      -90 |     -137 |      -28 |       46 | -273 |
| 1951 |       43 |      -74 |      -27 |      -81 |     -123 |      -25 |       41 | -246 |
| 1952 |       21 |      -37 |      -14 |      -40 |      -61 |      -12 |       21 | -122 |
| 1953 |       14 |      -24 |       -9 |      -26 |      -40 |       -8 |       13 |  -80 |
| 1954 |        0 |       -1 |       -0 |       -1 |       -1 |       -0 |        0 |   -2 |
| 1955 |        7 |      -13 |       -5 |      -14 |      -21 |       -4 |        7 |  -42 |
| 1956 |       11 |      -19 |       -7 |      -21 |      -32 |       -6 |       11 |  -64 |
| 1957 |       41 |      -71 |      -26 |      -78 |     -118 |      -24 |       40 | -236 |
| 1958 |       39 |      -67 |      -25 |      -74 |     -112 |      -23 |       38 | -224 |
| 1959 |        0 |       -1 |       -0 |       -1 |       -1 |       -0 |        0 |   -3 |
| 1960 |       37 |      -63 |      -23 |      -69 |     -105 |      -21 |       35 | -210 |
| 1961 |       37 |      -63 |      -23 |      -69 |     -104 |      -21 |       35 | -209 |
| 1962 |       56 |      -97 |      -36 |     -106 |     -161 |      -33 |       54 | -322 |
| 1963 |        5 |       -8 |       -3 |       -9 |      -14 |       -3 |        5 |  -28 |
| 1964 |       -9 |       16 |        6 |       18 |       27 |        5 |       -9 |   53 |
| 1965 |       31 |      -53 |      -20 |      -58 |      -89 |      -18 |       30 | -177 |
| 1966 |       52 |      -90 |      -33 |      -99 |     -150 |      -30 |       50 | -300 |
| 1967 |       21 |      -37 |      -14 |      -40 |      -61 |      -12 |       21 | -122 |
| 1968 |       45 |      -77 |      -29 |      -84 |     -128 |      -26 |       43 | -256 |
| 1969 |       24 |      -41 |      -15 |      -45 |      -69 |      -14 |       23 | -138 |
| 1970 |        6 |      -10 |       -4 |      -11 |      -16 |       -3 |        5 |  -32 |
| 1971 |       35 |      -61 |      -23 |      -67 |     -101 |      -21 |       34 | -203 |
| 1972 |      -42 |       72 |       27 |       79 |      119 |       24 |      -40 |  239 |
| 1973 |        4 |       -7 |       -2 |       -7 |      -11 |       -2 |        4 |  -22 |
| 1974 |       27 |      -46 |      -17 |      -50 |      -76 |      -15 |       26 | -152 |
| 1975 |       -7 |       13 |        5 |       14 |       21 |        4 |       -7 |   42 |
| 1976 |      -27 |       47 |       17 |       51 |       78 |       16 |      -26 |  156 |
| 1977 |        1 |       -2 |       -1 |       -3 |       -4 |       -1 |        1 |   -8 |
| 1978 |       -7 |       11 |        4 |       13 |       19 |        4 |       -6 |   38 |
| 1979 |        7 |      -12 |       -4 |      -13 |      -19 |       -4 |        7 |  -39 |
| 1980 |       18 |      -31 |      -12 |      -34 |      -52 |      -11 |       18 | -104 |
| 1981 |       37 |      -64 |      -24 |      -70 |     -106 |      -22 |       36 | -212 |
| 1982 |       24 |      -41 |      -15 |      -45 |      -68 |      -14 |       23 | -136 |
| 1983 |      -36 |       63 |       23 |       69 |      104 |       21 |      -35 |  208 |
| 1984 |      -14 |       24 |        9 |       26 |       40 |        8 |      -13 |   80 |
| 1985 |       14 |      -25 |       -9 |      -27 |      -41 |       -8 |       14 |  -82 |
| 1986 |       44 |       -9 |        6 |       -9 |       -6 |       16 |       19 |   62 |
| 1987 |       29 |      -12 |      -20 |      -22 |      -42 |       30 |       -0 |  -38 |
| 1988 |       -8 |      -30 |      -19 |        4 |      -38 |       -4 |        1 |  -95 |
| 1989 |        2 |      -34 |      -38 |      -13 |      -49 |      -17 |       -5 | -154 |
| 1990 |       -8 |      -18 |      -20 |      -29 |      -56 |        3 |        2 | -126 |
| 1991 |        5 |      -10 |      -14 |      -27 |      -33 |       14 |       -0 |  -66 |
| 1992 |       50 |      -15 |       14 |        9 |      -29 |       13 |       54 |   97 |
| 1993 |       36 |      -34 |      -12 |      -30 |      -56 |        2 |       13 |  -81 |
| 1994 |        6 |      -32 |       -7 |      -11 |      -25 |      -30 |       -6 | -106 |
| 1995 |      -29 |      -38 |      -21 |      -25 |      -34 |      -39 |      -19 | -205 |
| 1996 |       41 |       24 |      -15 |      -11 |       13 |       22 |       65 |  139 |
| 1997 |       23 |       -0 |        5 |      -17 |       -6 |       -6 |       16 |   15 |
| 1998 |      -21 |      -54 |      -17 |      -34 |      -43 |      -23 |      -41 | -233 |
| 1999 |        3 |       -6 |       19 |      -24 |      -30 |      -16 |       17 |  -38 |
| 2000 |       -9 |      -11 |       -5 |      -10 |      -12 |      -22 |       -0 |  -69 |
| 2001 |       14 |      -16 |       -3 |      -16 |      -22 |       -5 |       30 |  -18 |
| 2002 |       35 |      -61 |      -45 |      -42 |      -65 |       61 |      -17 | -135 |
| 2003 |        5 |      -39 |      -50 |      -46 |      -33 |       34 |      -32 | -160 |
| 2004 |       -3 |      -35 |      -28 |      -23 |      -23 |      -50 |        3 | -159 |
| 2005 |      -40 |      -26 |      -28 |      -37 |      -37 |      -30 |       36 | -162 |
| 2006 |      -22 |      -54 |        9 |      -15 |      -64 |      -60 |      -27 | -233 |
| 2007 |      -23 |      -54 |      -33 |      -29 |      -59 |      -17 |      -36 | -250 |
| 2008 |       37 |      -33 |      -30 |      -58 |      -80 |      -33 |        5 | -194 |
| 2009 |       -3 |      -73 |      -23 |      -42 |      -91 |       15 |      -19 | -237 |
| 2010 |      -52 |      -57 |      -41 |      -31 |      -34 |      -55 |     -101 | -371 |
| 2011 |       16 |      -82 |      -25 |      -45 |      -84 |      -45 |      -65 | -329 |
| 2012 |      -60 |      -62 |      -47 |      -57 |      -71 |      -48 |      -78 | -423 |
| 2013 |        2 |      -52 |       -9 |      -11 |      -49 |        6 |       13 | -100 |
| 2014 |       31 |      -62 |       -8 |      -39 |      -75 |        8 |      -32 | -177 |
| 2015 |       30 |      -57 |      -15 |      -57 |      -99 |      -16 |        9 | -206 |
| 2016 |        9 |      -61 |      -37 |      -37 |      -61 |        9 |      -75 | -253 |
| 2017 |       26 |      -21 |      -32 |      -24 |      -44 |      -17 |       13 | -100 |
| 2018 |       31 |      -41 |       25 |      -26 |      -59 |       -1 |       -5 |  -76 |
| 2019 |      -35 |      -96 |      -62 |      -62 |      -97 |       15 |      -89 | -427 |
| 2020 |       -0 |      -38 |       -6 |      -46 |      -72 |      -33 |        7 | -187 |
| 2021 |      -21 |      -39 |      -25 |      -31 |      -44 |      -42 |       -6 | -207 |
| 2022 |       19 |      -21 |       -2 |      -24 |      -36 |      -13 |       12 |  -64 |
| 2023 |      -11 |      -25 |      -33 |      -42 |      -56 |      -39 |      -14 | -219 |

#+begin_src jupyter-python :exports both
df.describe().round()
#+end_src

#+RESULTS:
|       |   1 [CE] |   2 [CW] |   3 [NE] |   4 [NO] |   5 [NW] |   6 [SE] |   7 [SW] |   GL |
|-------+----------+----------+----------+----------+----------+----------+----------+------|
| count |      184 |      184 |      184 |      184 |      184 |      184 |      184 |  184 |
| mean  |        9 |      -21 |       -9 |      -21 |      -33 |       -7 |        6 |  -76 |
| std   |       24 |       37 |       16 |       39 |       60 |       17 |       27 |  134 |
| min   |      -60 |     -154 |      -62 |     -169 |     -257 |      -60 |     -101 | -513 |
| 25%   |       -7 |      -46 |      -20 |      -45 |      -71 |      -16 |       -7 | -162 |
| 50%   |        7 |      -18 |       -7 |      -19 |      -32 |       -5 |        6 |  -65 |
| 75%   |       26 |       -1 |        1 |       -1 |       -1 |        4 |       21 |    0 |
| max   |       90 |       72 |       27 |       79 |      119 |       61 |       86 |  239 |

* Fetch data

#+BEGIN_SRC bash :exports both :results verbatim :wrap src json
export SERVER_URL=https://dataverse.geus.dk
export PERSISTENT_IDENTIFIER=doi:10.22008/FK2/OHI23Z
export METADATA_FORMAT=dataverse_json # ddi dataverse_json schema.org Datacite oai_datacite
curl "$SERVER_URL/api/datasets/export?exporter=$METADATA_FORMAT&persistentId=$PERSISTENT_IDENTIFIER" | jq .datasetVersion.versionNumber
#+END_SRC

#+RESULTS:
#+begin_src json
875
#+end_src

#+BEGIN_SRC bash :exports both :results verbatim
mkdir -p tmp/greenland_discharge
pushd tmp/greenland_discharge
wget -r -e robots=off -nH --cut-dirs=3 --content-disposition "https://dataverse.geus.dk/api/datasets/:persistentId/dirindex?persistentId=doi:10.22008/FK2/OHI23Z"
# wget -r -e robots=off -nH --cut-dirs=3 --content-disposition "https://dataverse.geus.dk/api/datasets/:persistentId/dirindex?persistentId=doi:10.22008/promice/data/ice_discharge/d/v02"
popd
#+END_SRC

* Reprocess

#+begin_src jupyter-python :exports both
import xarray as xr
import numpy as np

ds = xr.open_dataset('./tmp/greenland_discharge/MB_region.nc')

# Drop partial years
this_yr = ds['time'].to_series().iloc[-1].year
ds = ds.sel({'time':slice('1850',str(this_yr-1))})

# Scale early values to annual
ds.loc[{'time': slice('1850-01-01','1985-12-31')}] *= 365

# Resample by year
ds = ds.resample({'time':'YS'}).sum()

# subset to SMB and D. Keep MB as a check
ds = ds[['SMB_ROI','SMB','SMB_ROI_err','D','D_ROI','D_ROI_err','MB_ROI','MB',]]
ds = ds.rename({'MB_ROI':'MB_ROI_orig', 'MB':'MB_orig'})

# Convert [CE, CW, ..., SW] to [1, 2, ..., 7]
ds = ds.sortby('region')
ds['region_name'] = ds['region']
region_mapping = dict(zip(ds['region_name'].values, np.arange(ds['region_name'].size)+1))
ds = ds.assign_coords(region=[region_mapping[r] for r in ds.region.values])

###
###
###

# Prior to 1986 there is no regional resolution, just one value for all of Greenland.

# Split into regions by taking the 1990s percent of mass balance per
# region, and assuming the historical GIS-wide mass balance maintained
# that distribution (even if magnitude changed).
ds_ratio = ds.loc[{'time': slice('1990-01-01','1999-12-31')}].sum(dim='time')
ds_ratio = ds_ratio / ds_ratio.sum()

for r in ds['region'].values:
    # Set regional values to the average of the first 5 years when there is regional resolution
    ds['D_ROI'].sel({'region':r}).loc[{'time': slice('1850-01-01','1985-12-31')}] = ds['D'].loc[{'time': slice('1850-01-01','1985-12-31')}] * ds_ratio['D_ROI'].sel(region=r).values
    # Set regional uncertainty to the full range of observed values
    errmax = ds['D_ROI'].sel({'region':r, 'time':slice('1986-01-01','1999-12-31')}).max()
    errmin = ds['D_ROI'].sel({'region':r, 'time':slice('1986-01-01','1999-12-31')}).min()
    ds['D_ROI_err'].sel({'region':r}).loc[{'time': slice('1850-01-01','1985-12-31')}] = (errmax-errmin)

    ds['SMB_ROI'].sel({'region':r}).loc[{'time': slice('1850-01-01','1985-12-31')}] = ds['SMB'].loc[{'time': slice('1850-01-01','1985-12-31')}] * ds_ratio['SMB_ROI'].sel(region=r).values
    # Set regional uncertainty to the full range of observed values
    errmax = ds['SMB_ROI'].sel({'region':r, 'time':slice('1986-01-01','1999-12-31')}).max()
    errmin = ds['SMB_ROI'].sel({'region':r, 'time':slice('1986-01-01','1999-12-31')}).min()
    ds['SMB_ROI_err'].sel({'region':r}).loc[{'time': slice('1850-01-01','1985-12-31')}] = (errmax-errmin)

    ds = ds.transpose()

ds = ds.drop_vars(['D','SMB'])
ds = ds.drop_vars(['MB_orig','MB_ROI_orig'])

# Calculate ROI MB (prior to 1985) from ROI SMB and ROI D computed above
ds['MB_ROI'] = ds['SMB_ROI'] - ds['D_ROI']
ds['MB'] = ds['MB_ROI'].sum(dim='region')

# normalize so that 1850 to 1900 MB_ROIs all average to 0
offset = ds['MB_ROI'].loc[{'time': slice('1850-01-01','1899-12-31')}].mean(dim='time')
ds['MB_ROI'] = ds['MB_ROI'] - offset

for v in ['MB_ROI','SMB_ROI','D_ROI']:
    ds[v].attrs['units'] = 'Gt yr-1'
    
ds['MB_ROI'].attrs['long_name'] = 'Mass balance'
ds['MB_ROI'].attrs['standard_name'] = 'tendency_of_ice_mass'
ds['SMB_ROI'].attrs['long_name'] = 'Surface mass balance'
ds['SMB_ROI'].attrs['standard_name'] = 'tendency_of_ice_mass'
ds['D_ROI'].attrs['long_name'] = 'Discharge'
ds['D_ROI'].attrs['standard_name'] = 'tendency_of_ice_mass'

ds['time'].attrs['long_name'] = 'time'
ds['region'].attrs['long_name'] = 'Mouginot (2019) region'

ds.attrs['title'] = 'Greenland ice sheet mass balance by Mouginot region'
ds.attrs['history'] = 'TBD'
ds.attrs['Conventions'] = 'CF-1.8'

ds.attrs['summary'] = 'Greenland ice sheet mass balance by Mouginot region'
ds.attrs['creator_name'] = 'Ken Mankoff'
ds.attrs['creator_email'] = 'ken.mankoff@nasa.gov'
ds.attrs['institution'] = 'NASA GISS'
ds.attrs['references'] = 'TBD'
ds.attrs['DOI'] = 'https://doi.org/10.5281/zenodo.14020895'

comp = dict(zlib=True, complevel=5)
encoding = {} # var: comp for var in items}
encoding['time'] = {'dtype': 'i4'}

!rm ./dat/GL_mass_anomaly.nc
ds.to_netcdf('./dat/GL_mass_anomaly.nc', encoding=encoding)
#!ncdump -h ./dat/GL_mass_anomaly.nc
print(ds)
#+end_src

#+RESULTS:
#+begin_example
<xarray.Dataset> Size: 27kB
Dimensions:      (region: 7, time: 175)
Coordinates:
  ,* time         (time) datetime64[ns] 1kB 1850-01-01 1851-01-01 ... 2024-01-01
  ,* region       (region) int64 56B 1 2 3 4 5 6 7
Data variables:
    SMB_ROI      (region, time) float32 5kB 78.67 95.28 76.05 ... 9.538 55.99
    SMB_ROI_err  (region, time) float32 5kB 89.83 89.83 89.83 ... 1.431 8.399
    D_ROI        (region, time) float32 5kB 63.25 62.06 64.02 ... 18.45 18.96
    D_ROI_err    (region, time) float32 5kB 10.62 10.62 10.62 ... 1.971 2.062
    region_name  (region) <U2 56B 'CE' 'CW' 'NE' 'NO' 'NW' 'SE' 'SW'
    MB_ROI       (region, time) float32 5kB -9.589 8.216 -12.97 ... -27.28 18.66
    MB           (time) float32 700B -20.68 66.63 -38.08 ... -193.1 -88.34
Attributes: (12/14)
    featureType:      timeSeries
    title:            Greenland ice sheet mass balance by Mouginot region
    summary:          Greenland ice sheet mass balance by Mouginot region
    keywords:         Greenland; Mass; Mass balance
    source:           git commit: 54a4452
    creator_name:     Ken Mankoff
    ...               ...
    institution:      NASA GISS
    references:       TBD
    product_version:  1.0
    history:          TBD
    Conventions:      CF-1.8
    DOI:              https://doi.org/10.5281/zenodo.14020895
#+end_example
