
#+PROPERTY: header-args:jupyter-python+ :dir (file-name-directory buffer-file-name) :session davison_2023

* Table of contents                               :toc_3:noexport:
- [[#introduction][Introduction]]
  - [[#data-example][Data example]]
    - [[#printout][Printout]]
    - [[#graphic][Graphic]]
    - [[#calving-by-region][Calving by region]]
- [[#processing][Processing]]

* Introduction

+ Antarctic ice shelf calving is from Davison 2023
+ Antarctic non-shelf calving is the difference between Davison 2023 and Rignot 2019
  + Should be updated to Davison ESSD 2023 submitted 

** Data example

*** Printout

#+BEGIN_SRC jupyter-python :exports both :prologue "import xarray as xr" :display text/plain
xr.open_dataset('./dat/AQ_calving.nc')
#+END_SRC

#+RESULTS:
#+begin_example
<xarray.Dataset> Size: 8kB
Dimensions:      (region: 18, time: 25)
Coordinates:
  ,* time         (time) datetime64[ns] 200B 1997-07-01 1998-07-01 ... 2021-07-01
  ,* region       (region) int32 72B 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18
Data variables:
    calving      (region, time) float64 4kB ...
    uncertainty  (region, time) float64 4kB ...
    region_name  (region) <U5 360B ...
Attributes:
    description:   Antarctic region ice shelf calving rate
    date_created:  20241101T153743Z
    title:         Calving per region
    history:       Processed for Schmidt (YYYY; in prep); by Ken Mankoff
    source:        doi:10.5281/ZENODO.8052519
    Conventions:   CF-1.8
    DOI:           https://doi.org/10.5281/zenodo.14020895
#+end_example

*** Graphic

#+BEGIN_SRC jupyter-python :exports both :file ./fig/AQ_calving.png
import xarray as xr
ds = xr.open_dataset('./dat/AQ_calving.nc')
df = ds.sum(dim='region')['calving'].to_dataframe()
ax = df['calving'].plot(drawstyle='steps-post')

unc = (((ds['uncertainty']**2).sum(dim='region'))**0.5).to_dataframe()
unc.plot(drawstyle='steps-post', ax=ax)
_ = ax.set_ylabel('Calving [Gt yr$^{-1}$]')
#+END_SRC

#+RESULTS:
[[./fig/AQ_calving.png]]

*** Calving by region

#+BEGIN_SRC jupyter-python :exports both
import xarray as xr
import matplotlib.pyplot as plt

ds = xr.open_dataset('dat/AQ_calving.nc')
# ds = ds.assign_coords(region=[_[0] + ' ['+str(_[1])+']' for _ in zip(ds['region_name'].values,ds['region'].values)])
df = ds['calving'].to_dataframe()
df = df['calving'].unstack().T
df['AQ'] = df.sum(axis='columns')
df.index = [_[0:10] for _ in df.index.astype(str)]
df.round()
#+END_SRC

#+RESULTS:
|            |   1 |   2 |   3 |   4 |   5 |   6 |   7 |    8 |    9 |   10 |   11 |   12 |   13 |   14 |   15 |   16 |   17 |   18 |   AQ |
|------------+-----+-----+-----+-----+-----+-----+-----+------+------+------+------+------+------+------+------+------+------+------+------|
| 1997-07-01 |  56 |  37 |  42 |  93 | 141 | 114 |  26 |   43 |  108 |   83 |  200 |   37 |   48 |   45 |   10 |  139 |   93 |   48 | 1363 |
| 1998-07-01 |  56 |  37 |  42 |  93 | 141 | 114 |  26 |   43 |  108 |   83 |  200 |   37 |   48 |   45 |   10 | 1995 |   93 |   48 | 3219 |
| 1999-07-01 |  56 |  37 |  42 |  93 | 141 | 114 |  26 |   43 |  108 |   83 |  200 |   37 |   48 |   45 |   10 |  139 |   93 |   48 | 1363 |
| 2000-07-01 | -27 |  -9 | -56 | -60 |  33 | 262 |  12 |  -49 | 2941 |    3 |  127 |    4 |  214 |  211 |   62 | 2064 | -115 |  -45 | 5576 |
| 2001-07-01 | 105 | 227 |  11 | 179 | 296 | 169 | 111 |  129 |  134 |  302 |  475 |   67 |  138 |   75 |   37 |  153 |  102 |   61 | 2772 |
| 2002-07-01 |  27 |  17 |  -2 |  87 |  62 |  27 |   9 |   13 |  -13 |   34 |  230 |   21 |   43 |  436 |    1 |  -12 |    8 |   -2 |  987 |
| 2003-07-01 | 172 |  20 |   2 |  27 |  91 |  41 |  10 | 1058 |   -5 |   51 |  176 |   23 |   33 |   27 |    1 |  -14 |   10 |   -1 | 1722 |
| 2004-07-01 | 104 |  55 |  64 | 153 | 178 | 135 |  42 |   68 |  108 |  130 |  289 |   48 |   83 |   64 |   11 |   15 |   48 |   40 | 1634 |
| 2005-07-01 |  15 |  21 |   2 |  19 | 109 |  26 |  17 |   -2 |   25 |   52 |   51 |   34 |   46 |  347 |    1 |   -9 |   37 |   26 |  819 |
| 2006-07-01 |  65 |  28 | -12 |  49 | 155 |  71 |  36 |    1 |    9 |   94 |  102 |   27 |   38 |  162 |    5 |   41 |    7 |   17 |  893 |
| 2007-07-01 |  18 |  27 |  11 |  30 | 173 |  79 |  34 |    9 |   38 |   85 |  103 |   40 |   40 |   12 |    1 |  -55 |   10 |   24 |  680 |
| 2008-07-01 |   1 |  37 | -47 |   9 | 140 |  29 |   4 |  -30 |  -92 |   14 |   24 |   47 |  279 |   19 |    3 |  -27 |  -21 |  -12 |  379 |
| 2009-07-01 |  61 |  51 |  31 |  94 | 204 | 135 |  48 |   17 |   76 |  147 | 1670 |   71 |   93 |   58 |    8 |   85 |   69 |   55 | 2974 |
| 2010-07-01 |  11 |  46 |   6 | 111 | 128 | 613 |  20 |    6 |   32 |   79 |  230 |   80 |  255 |   36 |    2 |  -26 |   17 |   45 | 1692 |
| 2011-07-01 |  45 |  22 | -12 |  48 | 191 |  64 |  20 |  -10 |  -14 |   76 |   92 |   64 |   71 |   11 |    3 |  -24 |   -0 |   25 |  672 |
| 2012-07-01 |  -3 |  20 |  12 |  48 | 121 |  74 |  21 |   -1 |   20 |   97 |  180 |   39 |   54 |    3 |    4 |  -23 |   14 |   10 |  690 |
| 2013-07-01 |   5 |  20 | -17 |  57 | 121 |  38 |  10 |    0 |  -11 |   34 |  698 |   61 |   67 |   -4 |    3 |  -14 |    4 |    5 | 1076 |
| 2014-07-01 |  26 |  37 |   4 | 163 | 163 |  68 |  20 |    5 |   20 |   67 |  488 |   93 |   80 |   52 |   13 |   14 |   33 |   26 | 1374 |
| 2015-07-01 |  78 |  13 | -12 |  81 |  43 |  36 |  66 |   -5 |    2 |  148 |  220 |   70 |  107 |   13 |    3 |    5 |   -3 |   57 |  921 |
| 2016-07-01 |  37 |  16 | -11 |  42 | 105 |  22 |  17 |    7 |    9 |   50 |  302 |   34 |   49 |   14 |   -1 |   26 |    9 |   25 |  751 |
| 2017-07-01 |  66 |  82 |  -5 |  54 | 176 |  76 |  45 |   -5 |   -4 |  152 |  307 |   34 |   49 |   14 |    3 |    9 |    4 |   22 | 1079 |
| 2018-07-01 |  31 |  48 |  16 |  65 | 216 |  52 |  21 |   -0 |   10 |  107 |  207 |   35 |   50 | 1325 |    3 |   11 |    2 |   20 | 2218 |
| 2019-07-01 |  25 |  36 |  -6 |  60 | 126 |  42 |  20 |    6 |   -6 |   89 |  361 |   36 |   43 |   32 |    4 |    6 |    7 |   21 |  901 |
| 2020-07-01 |  19 |  36 | 367 |  56 | 153 | 110 |  52 |   -6 |    4 |  116 |  210 |   28 |   43 |   49 |    4 |   -1 |   -2 |   15 | 1254 |
| 2021-07-01 |  49 |  39 |   2 | 143 | 253 | 500 |  27 |    4 |   27 |  127 |  292 |   31 |   66 |   23 |  109 | 1019 |    7 |  176 | 2895 |

* Processing

#+begin_src jupyter-python :exports both
import numpy as np
import pandas as pd
import geopandas as gpd
import xarray as xr
import datetime

# shelf name with longitude and latitude
df = pd.read_excel("~/data/Davison_2023/adi0186_table_s2.xlsx",
                   sheet_name = 'Total mass changes',
                   usecols = (1,2,3), index_col = 0, skiprows = 4)
df = df.dropna()
shelf = gpd.GeoDataFrame(
    geometry=gpd.points_from_xy(df.longitude, df.latitude, crs="EPSG:4326"), data=df)
shelf = shelf.to_crs('EPSG:3031')

# region name
region = gpd.read_file("~/data//IMBIE/Rignot/ANT_Basins_IMBIE2_v1.6.shp")
region = region[region['Regions'] != 'Islands']

# find regions nearest each shelf
shelf_region = gpd.sjoin_nearest(shelf,region)
shelf_region = shelf_region.drop(columns=['index_right','latitude','longitude','Regions'])

# load calving time series per shelf
calving = pd.read_excel("~/data/Davison_2023/adi0186_table_s2.xlsx",
                        sheet_name='Calving', index_col=1, skiprows=3, header=(0,1))
calving = calving.T.dropna().drop(columns=['Antarctic Ice Shelves'])

obs = calving.xs('observed', level='Ice shelf')
obs.index.name = 'Date'
obs.index = pd.to_datetime(obs.index.astype(int).astype(str)+'-07-01', format="%Y-%m-%d")

# unc = calving.drop('observed', level=1, axis=0).reset_index().set_index('level_0').drop(columns=['Ice shelf'])
unc = calving.xs('uncertainty', level='Ice shelf')
unc.index.name = 'Date'
unc.index = obs.index

da_obs = xr.DataArray(data = obs.values,
                      dims = ['date','shelf'],
                      coords = {'date':obs.index.values, 'shelf':obs.columns})

ds = xr.Dataset({'calving': da_obs})
ds['uncertainty'] = (('date','shelf'), unc)
ds = ds.where(ds['shelf'] != 'Antarctic Ice Shelves', drop=True)
ds['region'] = (('shelf'), shelf_region['Subregion'])

# ds = ds.groupby('region').sum() # Want to agg() with different functions per column...

# uncertainty is sqrt of sum of squares. Not sure how to do this in-place in Xarray.
ds['unc2'] = ds['uncertainty']**2
ds2 = xr.merge([
    ds[['calving','region']].groupby('region').sum(),
    ds[['unc2','region']].groupby('region').sum(),
])
ds2['uncertainty'] = np.sqrt(ds2['unc2'])
ds2 = ds2.drop_vars('unc2')
# uncertainty for all of AQ as (sum(u**2))**0.5 matches Davison 2023 row 168 "Antarctic Ice Shelves"

# need to calculate AQ-wide uncertainty at shelf resolution because step-aggregating is not commutative
# ds2['uncertainty_AQ'] = np.sqrt(ds['unc2'].sum(dim='shelf'))

ds = ds2

ds = ds.rename({'date':'time'})
ds['region'] = np.arange(18).astype(np.int32) + 1

ds['region_name'] = (('region'), ['A-Ap', 'Ap-B', 'B-C', 'C-Cp', 'Cp-D',
                                'D-Dp', 'Dp-E', 'E-Ep', 'Ep-F', 'F-G',
                                'G-H', 'H-Hp', 'Hp-I', 'I-Ipp', 'Ipp-J',
                                'J-Jpp', 'Jpp-K', 'K-A'])

ds.attrs['description'] = 'Antarctic region ice shelf calving rate'
ds['calving'].attrs['units'] = 'Gt yr-1'
ds['calving'].attrs['long_name'] = 'Shelf calving'

# ds['calving'].attrs['standard_name'] = 'water_flux_into_sea_water_from_land_ice'
# https://github.com/orgs/cf-convention/discussions/388
ds['calving'].attrs['standard_name'] = 'ice_transport_across_line'

ds['uncertainty'].attrs['long_name'] = 'Uncertainty of shelf calving'
ds['time'].attrs['standard_name'] = 'time'
ds['region'].attrs['long_name'] = 'IMBIE region'
ds.attrs['date_created'] = datetime.datetime.now(datetime.timezone.utc).strftime("%Y%m%dT%H%M%SZ")
ds.attrs['title'] = 'Calving per region'
ds.attrs['history'] = 'Processed for Schmidt (YYYY; in prep); by Ken Mankoff'
ds.attrs['source'] = 'doi:10.5281/ZENODO.8052519'
ds.attrs['Conventions'] = 'CF-1.8'
ds.attrs['DOI'] = 'https://doi.org/10.5281/zenodo.14020895'

comp = dict(zlib=True, complevel=5)
encoding = {}
encoding['time'] = {'dtype': 'i4'}

!rm ./dat/AQ_calving.nc
ds.to_netcdf('./dat/AQ_calving.nc', encoding=encoding)
!ncdump -h ./dat/AQ_calving.nc
#+end_src

#+RESULTS:
#+begin_example
netcdf AQ_calving {
dimensions:
	region = 18 ;
	time = 25 ;
variables:
	double calving(region, time) ;
		calving:_FillValue = NaN ;
		calving:units = "Gt yr-1" ;
		calving:long_name = "Shelf calving" ;
		calving:standard_name = "ice_transport_across_line" ;
	int time(time) ;
		time:standard_name = "time" ;
		time:units = "days since 1997-07-01 00:00:00" ;
		time:calendar = "proleptic_gregorian" ;
	int region(region) ;
		region:long_name = "IMBIE region" ;
	double uncertainty(region, time) ;
		uncertainty:_FillValue = NaN ;
		uncertainty:long_name = "Uncertainty of shelf calving" ;
	string region_name(region) ;

// global attributes:
		:description = "Antarctic region ice shelf calving rate" ;
		:date_created = "20241101T153743Z" ;
		:title = "Calving per region" ;
		:history = "Processed for Schmidt (YYYY; in prep); by Ken Mankoff" ;
		:source = "doi:10.5281/ZENODO.8052519" ;
		:Conventions = "CF-1.8" ;
		:DOI = "https://doi.org/10.5281/zenodo.14020895" ;
}
#+end_example

